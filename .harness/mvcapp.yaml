pipeline:
    name: mvcapp
    identifier: mvcapp
    projectIdentifier: luke
    orgIdentifier: default
    tags: {}
    properties:
        ci:
            codebase:
                connectorRef: luke_github
                repoName: mvcapp
                build: <+input>
    stages:
        - stage:
              name: Build
              identifier: build
              description: ""
              type: CI
              spec:
                  cloneCodebase: true
                  infrastructure:
                      type: KubernetesDirect
                      spec:
                          connectorRef: minikube
                          namespace: ci
                  execution:
                      steps:
                          - step:
                                type: Run
                                name: git testing
                                identifier: git_testing
                                spec:
                                    connectorRef: luke_docker_hub
                                    image: alpine/git:latest
                                    command: |-
                                        set -e
                                        set -x
                                        # if the netrc enviornment variables exist, write
                                        # the netrc file.

                                        if [[ ! -z "${DRONE_NETRC_MACHINE}" ]]; then
                                            cat <<EOF > ${HOME}/.netrc
                                        machine ${DRONE_NETRC_MACHINE}
                                        login ${DRONE_NETRC_USERNAME}
                                        password ${DRONE_NETRC_PASSWORD}
                                        EOF
                                        fi

                                        # if the ssh_key environment variable exists, write
                                        # the ssh key and add the netrc machine to the
                                        # known hosts file.

                                        if [[ ! -z "${DRONE_SSH_KEY}" ]]; then
                                            mkdir ${HOME}/.ssh
                                            echo -n "$DRONE_SSH_KEY" > ${HOME}/.ssh/id_rsa
                                            chmod 600 ${HOME}/.ssh/id_rsa

                                            touch ${HOME}/.ssh/known_hosts
                                            chmod 600 ${HOME}/.ssh/known_hosts
                                            ssh-keyscan -H ${DRONE_NETRC_MACHINE} > /etc/ssh/ssh_known_hosts 2> /dev/null
                                        fi

                                        # configure git global behavior and parameters via the
                                        # following environment variables:


                                        if [[ -z "${DRONE_COMMIT_AUTHOR_NAME}" ]]; then
                                            export DRONE_COMMIT_AUTHOR_NAME=harness
                                        fi

                                        if [[ -z "${DRONE_COMMIT_AUTHOR_EMAIL}" ]]; then
                                            export DRONE_COMMIT_AUTHOR_EMAIL=no-reply@harness.io
                                        fi

                                        export GIT_AUTHOR_NAME=${DRONE_COMMIT_AUTHOR_NAME}
                                        export GIT_AUTHOR_EMAIL=${DRONE_COMMIT_AUTHOR_EMAIL}
                                        export GIT_COMMITTER_NAME=${DRONE_COMMIT_AUTHOR_NAME}
                                        export GIT_COMMITTER_EMAIL=${DRONE_COMMIT_AUTHOR_EMAIL}
                                        env
                                        # echo "<+pipeline.name>" > output.txt
                                        # git config --global user.email "luke.hertert@gmail.com"
                                        # git config --global user.name "Luke Hertert"
                                        # git status
                                        #git add .
                                        # git commit -m "Add new file"                                       
                                        # git push origin <+codebase.branch>
                                    privileged: false
                          - step:
                                type: Plugin
                                name: Build docker image
                                identifier: Build_docker_image
                                spec:
                                    connectorRef: luke_docker_hub
                                    image: plugins/docker
                                    privileged: false
                                    settings:
                                        dry_run: "true"
                                        repo: ldhertert/mvcapp
                                    imagePullPolicy: IfNotPresent
                                when:
                                    stageStatus: Success
                                    condition: <+pipeline.name> == "success"
                                failureStrategies: []
              variables: []
